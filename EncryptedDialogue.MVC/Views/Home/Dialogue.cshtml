@using EncryptedDialogue.MVC.Models
@using Microsoft.AspNet.Identity
@model EncryptedDialogue.MVC.Models.DialoguesVewModel

@{
    ViewBag.Title = "Dialogue";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Диалог</h2>

<hr/>

@if (!Model.Dialogues.Any())
{
    <h4 style="text-indent: 150px">Нет сообщений</h4>
}

    <div style="height: 100vh;
  display: flex;
  flex-direction: column-reverse;
  flex-wrap: nowrap;">
        <ul>
            @foreach (var message in Model.Dialogues)
            {
                if (!string.IsNullOrEmpty(message.MessageText))
                {
                    <li>
                        <div class="row">
                            <div class="col-md-3">
                                @Model.ApplicationUsers.First(x => x.Id == message.SenderId).UserName
                            </div>

                            <div class="col-md-7">
                                @message.MessageText

                            </div>

                            <div class="col-md-2">
                                @message.DateTime
                            </div>
                        </div>
                    </li>
                }
                if (message.FileDataId != 0)
                {
                    <li>
                        <div class="row">
                            <div class="col-md-3">
                                @Model.ApplicationUsers.First(x => x.Id == message.SenderId).UserName
                            </div>

                            <div class="col-md-7">
                                <a href="@Url.RouteUrl("Default", new {controller = "Home", action = string.Join(string.Empty, "Download/" + Model.FileDatas.First(x => x.Id == message.FileDataId).Id)})">
                                    @if (Model.FileDatas.First(x => x.Id == message.FileDataId).Name.Contains("jpg") || Model.FileDatas.First(x => x.Id == message.FileDataId).Name.Contains("jpeg") ||
                                         Model.FileDatas.First(x => x.Id == message.FileDataId).Name.Contains("bmp") || Model.FileDatas.First(x => x.Id == message.FileDataId).Name.Contains("png"))
                                    {
                                        try
                                        {
                                            var base64 = Convert.ToBase64String(Model.FileDatas.First(x => x.Id == message.FileDataId).ByteArrayData);
                                            var imgSrc = $"data:image/gif;base64,{base64}";
                                            <img src="@imgSrc" alt="Error image" height="354" , width="630" />
                                        }
                                        catch (Exception)
                                        {
                                            // ignored
                                        }
                                    }
                                    else if (Model.FileDatas.First(x => x.Id == message.FileDataId).Name.Contains("mp3"))
                                    {
                                        <audio controls>
                                            <source src="@Url.RouteUrl("Default", new {controller = "Home", action = string.Join(string.Empty, "Play/" + Model.FileDatas.First(x => x.Id == message.FileDataId).Id)})" type="audio/mpeg">
                                            Your browser does not support the audio element.
                                        </audio>
                                        <a href="@Url.RouteUrl("Default", new {controller = "Home", action = string.Join(string.Empty, "Download/" + Model.FileDatas.First(x => x.Id == message.FileDataId).Id)})">Скачать</a>
                                    }
                                    else
                                    {
                                        @Model.FileDatas.First(x => x.Id == message.FileDataId).Name

                                    }
                                </a>

                            </div>

                            <div class="col-md-2">

                            </div>
                        </div>
                    </li>
                }
                <br />
            }
        </ul>
    </div>

<hr />

@using (Html.BeginForm("Dialogue", "Home", FormMethod.Post, new { enctype = "multipart/form-data" }))
{
    @Html.ValidationSummary(true)
    @Html.AntiForgeryToken()
    @Html.Hidden("recepientId")

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-6">
                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                <div class="form-group">
                    @Html.Label("Сообщение", htmlAttributes: new { @class = "control-label col-md-2" })
                    <div class="col-md-10">
                        @Html.TextArea("MessageText", new { htmlAttributes = new { @class = "form-control", name = "messageText" } })
                    </div>
                </div>
            </div>
        
            <div class="col-md-4">
                <div style="position:relative;">
                    <label>Вложение</label>
                    <a class='btn' href='javascript:;'>
                        Выберите файл...
                        <input type="file" name="uploadFile" size="40"
                               style="position:absolute;z-index:2;top:0;
                                                                                                                                                             left:0;filter: alpha(opacity=0); opacity:0;
                                                                                                                                                             background-color:transparent;color:transparent;"
                               onchange='$("#upload-file-info").html($(this).val());'>
                    </a>
                    <span class='label label-info' id="upload-file-info"></span>
                </div>
            </div>
        
            <div class="form-group" align="center">
                <div class="col-md-offset-2 col-md-10">
                    <input type="submit" value="Отправить" class="btn btn-default" />
                </div>
            </div>
        </div>
    </div>
}